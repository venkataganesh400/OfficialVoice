

{% extends 'base.html' %}
{% block title %}{{ poll.topic }} - Community Chat{% endblock %}

{% block content %}
<div class="chat-page-layout">
    <div class="chat-window">
        <div class="chat-header">
            <a href="{{ url_for('poll_view', poll_id=poll.id) }}" class="back-btn"><i class="fas fa-chevron-left"></i></a>
            <div>
                <a href="{{ url_for('poll_view', poll_id=poll.id) }}">‚Üê Back to Poll Details</a>
                <h4>{{ poll.topic }}</h4>
            </div>
        </div>
        <div class="message-list" id="message-list">
            {% for msg in messages %}
            <div class="message {% if msg.user_id == g.user.id %}sent{% else %}received{% endif %}">
                {% if msg.user_id != g.user.id %}
                    <div class="message-author">
                        <a href="{{ url_for('public_profile', voter_id=msg.author.voter_id) }}" style="text-decoration: none; color: inherit;">
                            {{ msg.author.first_name }}
                        </a>
                    </div>
                {% endif %}
                <p class="message-text">{{ msg.text }}</p>
            </div>
            {% else %}
            <div class="server-message">
                <p>Welcome to the chat for this poll. Be the first to say something!</p>
            </div>
            {% endfor %}
        </div>
        <form class="message-form" id="message-form">
            <input type="text" id="message-input" placeholder="Join the conversation..." autocomplete="off" required>
            <button type="submit" class="btn" title="Send"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>
    <div class="participant-list">
        <h4>Participants ({{ participants|length }})</h4>
        <div id="participants-container">
        {% for p in participants|sort(attribute='first_name') %}
        <div class="participant-item">
            <div class="online-indicator {% if p.id in online_users_list %}online{% endif %}" id="status-indicator-{{ p.id }}"></div>
            <span><a href="{{ url_for('public_profile', voter_id=p.voter_id) }}" style="text-decoration:none; color:inherit;">{{ p.first_name }} {{ p.last_name }}</a></span>
        </div>
        {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const messageList = document.getElementById('message-list');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const roomId = "{{ room_id }}";
    const currentUserId = {{ g.user.id }};
    const socket = io();

    function scrollToBottom() {
        if(messageList) messageList.scrollTop = messageList.scrollHeight;
    }
    scrollToBottom();

    socket.on('connect', () => {
        if(roomId) socket.emit('join_room', { room: roomId });
    });

    socket.on('user_status_change', data => {
        const indicator = document.getElementById(`status-indicator-${data.user_id}`);
        if (indicator) {
            indicator.classList.toggle('online', data.status === 'online');
            indicator.title = data.status === 'online' ? 'Online' : 'Offline';
        }
    });

    socket.on('receive_message', function(data) {
        if (!messageList) return;

        const isScrolledToBottom = messageList.scrollHeight - messageList.clientHeight <= messageList.scrollTop + 5;

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');

        const textP = document.createElement('p');
        textP.classList.add('message-text');
        textP.textContent = data.text;

        if (data.author_id === currentUserId) {
            messageDiv.classList.add('sent');
        } else {
            messageDiv.classList.add('received');
            const authorDiv = document.createElement('div');
            authorDiv.className = 'message-author';
            authorDiv.textContent = data.author_name;
            messageDiv.appendChild(authorDiv);
        }
        
        messageDiv.appendChild(textP);
        messageList.appendChild(messageDiv);
        
        const placeholder = messageList.querySelector('.server-message');
        if(placeholder) placeholder.remove();

        if(isScrolledToBottom) scrollToBottom();
    });

    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && roomId) {
                socket.emit('send_message', { text: text, room: roomId });
                messageInput.value = '';
                messageInput.focus();
            }
        });
    }
});
</script>
{% endblock %}
